// Generated by CoffeeScript 1.12.7
(function() {
  var ChildProcess, Fs, GitLogUtils, Path, _;

  ChildProcess = require("child_process");

  Path = require("path");

  Fs = require("fs");

  _ = require('underscore');

  module.exports = GitLogUtils = (function() {
    function GitLogUtils() {}


    /*
      returns an array of javascript objects representing the commits that effected the requested file
      with line stats, that looks like this:
        [{
          "id": "1c41d8f647f7ad30749edcd0a554bd94e301c651",
          "authorName": "Bee Wilkerson",
          "relativeDate": "6 days ago",
          "authorDate": 1450881433,
          "message": "docs all work again after refactoring to bumble-build",
          "body": "",
          "hash": "1c41d8f",
          "linesAdded": 2,
          "linesDeleted": 2
        }, {
          ...
        }]
     */

    GitLogUtils.getCommitHistory = function(fileName) {
      var lastCommitObj, logItems, rawLog;
      logItems = [];
      lastCommitObj = null;
      rawLog = this._fetchFileHistory(fileName);
      return this._parseGitLogOutput(rawLog);
    };

    GitLogUtils._fetchFileHistory = function(fileName) {
      var cmd, directory, flags, format, fstats;
      format = ("{\"id\": \"%H\", \"authorName\": \"%an\", \"relativeDate\": \"%cr\", \"authorDate\": %at, " + " \"message\": \"%s\", \"body\": \"%b\", \"hash\": \"%h\"}").replace(/\"/g, "#/dquotes/");
      flags = " --pretty=\"format:" + format + "\" --topo-order --date=local --numstat";
      fstats = Fs.statSync(fileName);
      if (fstats.isDirectory()) {
        directory = fileName;
        fileName = ".";
      } else {
        directory = Path.dirname(fileName);
        fileName = Path.basename(fileName);
      }
      cmd = "git log" + flags + " " + fileName;
      if (process.env.DEBUG === '1') {
        console.warn('$ ' + cmd);
      }
      return ChildProcess.execSync(cmd, {
        stdio: 'pipe',
        cwd: directory
      }).toString();
    };

    GitLogUtils._parseGitLogOutput = function(output) {
      var addLogItem, currentCommitText, fileName, files, i, lastCommitObject, len, line, linesAdded, linesDeleted, logItems, logLines, matches, ref, totalLinesAdded, totalLinesDeleted;
      lastCommitObject = null;
      logItems = [];
      logLines = output.split("\n");
      currentCommitText = null;
      totalLinesAdded = 0;
      totalLinesDeleted = 0;
      files = [];
      addLogItem = (function(_this) {
        return function() {
          var commitObj;
          commitObj = _this._parseCommitObj(currentCommitText);
          commitObj.linesAdded = totalLinesAdded;
          commitObj.linesDeleted = totalLinesDeleted;
          commitObj.files = files;
          logItems.push(commitObj);
          totalLinesAdded = 0;
          totalLinesDeleted = 0;
          return files = [];
        };
      })(this);
      for (i = 0, len = logLines.length; i < len; i++) {
        line = logLines[i];
        if (line.match(/^\{\#\/dquotes\/id\#\/dquotes\/\:/)) {
          if (currentCommitText != null) {
            addLogItem();
          }
          currentCommitText = line;
        } else if ((matches = line.match(/^([\d\-]+)\s+([\d\-]+)\s+(.*)/))) {
          ref = matches.slice(1), linesAdded = ref[0], linesDeleted = ref[1], fileName = ref[2];
          linesAdded = parseInt(linesAdded);
          linesDeleted = parseInt(linesDeleted);
          totalLinesAdded += linesAdded;
          totalLinesDeleted += linesDeleted;
          files.push({
            name: fileName.trim(),
            linesAdded: linesAdded,
            linesDeleted: linesDeleted
          });
        } else if (line != null) {
          currentCommitText += line;
        }
      }
      if (currentCommitText) {
        addLogItem();
      }
      return logItems;
    };

    GitLogUtils._parseCommitObj = function(line) {
      var encLine;
      encLine = line.replace(/\t/g, '  ').replace(/\"/g, "'").replace(/(\n|\n\r)/g, ' <br>').replace(/\r/g, ' <br>').replace(/\#\/dquotes\//g, '"').replace(/\\/g, '\\\\').replace(/[\x00-\x1F\x7F-\x9F]/g, ' ');
      try {
        return JSON.parse(encLine);
      } catch (error) {
        console.warn(line + "\n\n");
        console.warn("failed to parse JSON " + encLine);
        return null;
      }
    };


    /*
      See nodejs Path.normalize().  This method extends Path.normalize() to add:
      - escape of space characters
     */

    GitLogUtils._escapeForCli = function(filePath) {
      var escapePrefix;
      escapePrefix = process.platform === 'win32' ? '^' : '\\';
      return filePath.replace(/([\s\(\)\-])/g, escapePrefix + '$1');
    };

    return GitLogUtils;

  })();

}).call(this);
