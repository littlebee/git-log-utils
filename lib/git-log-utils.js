// Generated by CoffeeScript 1.12.5
(function() {
  var ChildProcess, Fs, GitLogUtils, Path, _;

  ChildProcess = require("child_process");

  Path = require("path");

  Fs = require("fs");

  _ = require('underscore');

  module.exports = GitLogUtils = (function() {
    function GitLogUtils() {}


    /*
      returns an array of javascript objects representing the commits that effected the requested file
      with line stats, that looks like this:
        [{
          "id": "1c41d8f647f7ad30749edcd0a554bd94e301c651",
          "authorName": "Bee Wilkerson",
          "relativeDate": "6 days ago",
          "authorDate": 1450881433,
          "message": "docs all work again after refactoring to bumble-build",
          "body": "",
          "hash": "1c41d8f",
          "linesAdded": 2,
          "linesDeleted": 2
        }, {
          ...
        }]
     */

    GitLogUtils.getCommitHistory = function(fileName) {
      var lastCommitObj, logItems, rawLog;
      logItems = [];
      lastCommitObj = null;
      rawLog = this._fetchFileHistory(fileName);
      return this._parseGitLogOutput(rawLog);
    };

    GitLogUtils.isGit = function(directory) {
      var error;
      try {
        return ChildProcess.execSync('git rev-parse --is-inside-work-tree', {
          stdio: 'pipe',
          cwd: directory
        }) && true;
      } catch (error1) {
        error = error1;
        return false;
      }
    };

    GitLogUtils.isHg = function(directory) {
      var error;
      try {
        return ChildProcess.execSync('hg root', {
          stdio: 'pipe',
          cwd: directory
        }) && true;
      } catch (error1) {
        error = error1;
        return false;
      }
    };

    GitLogUtils._fetchHgFileHistoryCmd = function(fileName) {
      var flags, format;
      format = ("\\{\"id\": \"{node}\", \"authorName\": \"{author|person}\", \"relativeDate\": \"{date|age}\", " + " \"authorDate\": \"{date(date, '%s')}\", \"message\": \"{desc|firstline}\", " + " \"body\": \"{sub(r'^.*\\n?\\n?', '', desc)}\", \"hash\": \"{node|short}\"," + " \"linesModified\": \"{diffstat}\"\}\n").replace(/\"/g, "#/dquotes/");
      flags = "--template \"" + format + "\"";
      return "hg log " + flags + " " + fileName;
    };

    GitLogUtils._fetchGitFileHistoryCmd = function(fileName) {
      var flags, format;
      format = ("{\"id\": \"%H\", \"authorName\": \"%an\", \"relativeDate\": \"%cr\", \"authorDate\": %at, " + " \"message\": \"%s\", \"body\": \"%b\", \"hash\": \"%h\"}").replace(/\"/g, "#/dquotes/");
      flags = " --pretty=\"format:" + format + "\" --topo-order --date=local --numstat";
      return "git log" + flags + " " + fileName;
    };

    GitLogUtils._fetchFileHistory = function(fileName) {
      var cmd, directory, fstats;
      fstats = Fs.statSync(fileName);
      if (fstats.isDirectory()) {
        directory = fileName;
        fileName = "";
      } else {
        directory = Path.dirname(fileName);
      }
      fileName = Path.normalize(this._escapeForCli(fileName));
      cmd = null;
      if (this.isGit(directory)) {
        cmd = this._fetchGitFileHistoryCmd(fileName);
      } else if (this.isHg(directory)) {
        cmd = this._fetchHgFileHistoryCmd(fileName);
      } else {
        throw "Not a GIT or MERCURIAL directory " + directory;
      }
      if (process.env.DEBUG === '1') {
        console.log('$ ' + cmd);
      }
      return ChildProcess.execSync(cmd, {
        stdio: 'pipe',
        cwd: directory
      }).toString();
    };

    GitLogUtils._parseGitLogOutput = function(output) {
      var _added, _added_deleted, _deleted, _modified, i, lastCommitObj, lastCommitObject, len, line, logItems, logLines, matches, ref, ref1;
      lastCommitObject = null;
      logItems = [];
      logLines = output.split("\n");
      for (i = 0, len = logLines.length; i < len; i++) {
        line = logLines[i];
        if (line[0] === '{' && line[line.length - 1] === '}') {
          lastCommitObj = this._parseCommitObj(line);
          if (lastCommitObj) {
            logItems.push(lastCommitObj);
          }
        } else if (line[0] === '{') {
          lastCommitObj = line;
        } else if (_.isString(lastCommitObj)) {
          lastCommitObj += line;
          if (line[line.length - 1] === '}') {
            lastCommitObj = this._parseCommitObj(lastCommitObj);
            if (lastCommitObj) {
              logItems.push(lastCommitObj);
            }
          }
        } else if ((lastCommitObj != null) && (matches = line.match(/^(\d+)\s*(\d+).*/))) {
          lastCommitObj.linesAdded = (lastCommitObj.linesAdded || 0) + Number.parseInt(matches[1]);
          lastCommitObj.linesDeleted = (lastCommitObj.linesDeleted || 0) + Number.parseInt(matches[2]);
        }
        if (lastCommitObj && typeof lastCommitObj.linesModified === 'string') {
          ref = lastCommitObj.linesModified.split(':'), _modified = ref[0], _added_deleted = ref[1];
          ref1 = _added_deleted.split('/'), _added = ref1[0], _deleted = ref1[1];
          lastCommitObj.linesAdded = Number.parseInt(_added);
          lastCommitObj.linesDeleted = Number.parseInt(_deleted) * -1;
          delete lastCommitObj.linesModified;
        }
      }
      return logItems;
    };

    GitLogUtils._parseCommitObj = function(line) {
      var encLine;
      encLine = line.replace(/\t/g, '  ').replace(/\"/g, "'").replace(/(\n|\n\r)/g, '<br>').replace(/\r/g, '<br>').replace(/\#\/dquotes\//g, '"');
      try {
        return JSON.parse(encLine);
      } catch (error1) {
        console.warn("failed to parse JSON " + encLine);
        return null;
      }
    };


    /*
      See nodejs Path.normalize().  This method extends Path.normalize() to add:
      - escape of space characters
     */

    GitLogUtils._escapeForCli = function(filePath) {
      var escapePrefix;
      escapePrefix = process.platform === 'win32' ? '^' : '\\';
      return filePath.replace(/([\s\(\)\-])/g, escapePrefix + '$1');
    };

    return GitLogUtils;

  })();

}).call(this);
